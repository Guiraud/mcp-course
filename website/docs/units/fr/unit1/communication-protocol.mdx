import Youtube from "@site/src/components/Youtube"
import Astuce from "@site/src/components/Astuce"
import Style from "@site/src/components/Style"

# Le protocole de communication

MCP dÃ©finit un protocole de communication standardisÃ© qui permet aux Clients et Serveurs d'Ã©changer des messages de maniÃ¨re cohÃ©rente et prÃ©visible. Cette standardisation est cruciale pour l'interopÃ©rabilitÃ© au sein de la communautÃ©. Dans cette section, nous explorerons la structure du protocole et les mÃ©canismes de transport utilisÃ©s dans MCP.

:::warning

Nous allons entrer dans les dÃ©tails techniques du protocole MCP. Vous n'aurez pas besoin de tout connaÃ®tre pour dÃ©velopper avec MCP, mais il est utile de comprendre son existence et son fonctionnement.

:::

## JSON-RPC : Les bases

Au cÅ“ur de MCP se trouve **JSON-RPC 2.0** comme format de message pour toute communication entre Clients et Serveurs. JSON-RPC est un protocole d'appel de procÃ©dure distante lÃ©ger encodÃ© en JSON, ce qui le rend :

- Lisible et facile Ã  dÃ©boguer
- IndÃ©pendant du langage, permettant une implÃ©mentation dans tout environnement de programmation
- Bien Ã©tabli, avec des spÃ©cifications claires et une adoption gÃ©nÃ©ralisÃ©e

![types de messages](https://huggingface.co/datasets/mcp-course/images/resolve/main/unit1/5.png)

Le protocole dÃ©finit trois types de messages :

### 1. RequÃªtes

EnvoyÃ©es du Client au Serveur pour initier une opÃ©ration. Une requÃªte contient :
- Un identifiant unique (`id`)
- Le nom de la mÃ©thode Ã  invoquer (ex : `tools/call`)
- Les paramÃ¨tres de la mÃ©thode (le cas Ã©chÃ©ant)

Exemple de requÃªte :

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "weather",
    "arguments": {
      "location": "San Francisco"
    }
  }
}
```

### 2. RÃ©ponses

EnvoyÃ©es du Serveur au Client en rÃ©ponse Ã  une requÃªte. Une rÃ©ponse contient :
- Le mÃªme `id` que la requÃªte correspondante
- Soit un `result` (succÃ¨s), soit une `error` (Ã©chec)

Exemple de rÃ©ponse rÃ©ussie :
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "temperature": 62,
    "conditions": "Partly cloudy"
  }
}
```

Exemple de rÃ©ponse d'erreur :
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "error": {
    "code": -32602,
    "message": "Invalid location parameter"
  }
}
```

### 3. Notifications

Messages unidirectionnels ne nÃ©cessitant pas de rÃ©ponse. GÃ©nÃ©ralement envoyÃ©s du Serveur au Client pour fournir des mises Ã  jour ou des notifications d'Ã©vÃ©nements.

Exemple de notification :
```json
{
  "jsonrpc": "2.0",
  "method": "progress",
  "params": {
    "message": "Processing data...",
    "percent": 50
  }
}
```

## MÃ©canismes de transport

JSON-RPC dÃ©finit le format des messages, mais MCP prÃ©cise aussi comment ces messages sont transportÃ©s entre Clients et Serveurs. Deux mÃ©canismes principaux sont supportÃ©s :

### stdio (EntrÃ©e/Sortie standard)

Le transport stdio est utilisÃ© pour la communication locale, lorsque le Client et le Serveur tournent sur la mÃªme machine :

L'application hÃ´te lance le Serveur comme un sous-processus et communique avec lui en Ã©crivant sur son entrÃ©e standard (stdin) et en lisant sa sortie standard (stdout).

:::tip

**Cas d'usage** : outils locaux comme l'accÃ¨s au systÃ¨me de fichiers ou l'exÃ©cution de scripts locaux.

:::

Les **avantages** principaux de ce transport sont sa simplicitÃ©, l'absence de configuration rÃ©seau et l'isolation sÃ©curisÃ©e par le systÃ¨me d'exploitation.

### HTTP + SSE (Server-Sent Events) / HTTP streamable

Le transport HTTP+SSE est utilisÃ© pour la communication distante, lorsque le Client et le Serveur peuvent Ãªtre sur des machines diffÃ©rentes :

La communication se fait via HTTP, le Serveur utilisant Server-Sent Events (SSE) pour pousser des mises Ã  jour vers le Client via une connexion persistante.

:::tip

**Cas d'usage** : connexion Ã  des API distantes, services cloud ou ressources partagÃ©es.

:::

Les **avantages** principaux sont la compatibilitÃ© rÃ©seau, l'intÃ©gration avec les services web et la compatibilitÃ© avec les environnements serverless.

Les derniÃ¨res Ã©volutions du standard MCP ont introduit ou amÃ©liorÃ© le "Streamable HTTP", qui offre plus de flexibilitÃ© en permettant au serveur de passer dynamiquement au mode SSE pour le streaming si besoin, tout en restant compatible avec les environnements serverless.

## Cycle de vie d'une interaction

Dans la section prÃ©cÃ©dente, nous avons vu le cycle de vie d'une interaction unique entre un Client (ğŸ’») et un Serveur (ğŸŒ). Regardons maintenant le cycle complet d'une interaction dans le contexte du protocole MCP.

Le protocole MCP dÃ©finit un cycle de vie structurÃ© entre Clients et Serveurs :

### Initialisation

Le Client se connecte au Serveur et ils Ã©changent les versions du protocole et les capacitÃ©s supportÃ©es. Le Serveur rÃ©pond avec sa version et ses capacitÃ©s.

<table style={{width: "100%"}}>
  <tr>
    <td style={{backgroundColor: "lightgreen", textAlign: "center", padding: "10px", border: "1px solid #ccc", borderRadius: "4px"}}>ğŸ’»</td>
    <td style={{textAlign: "center"}}>â†’<br />initialize</td>
    <td style={{backgroundColor: "lightblue", textAlign: "center", padding: "10px", border: "1px solid #ccc", borderRadius: "4px"}}>ğŸŒ</td>
  </tr>
  <tr>
    <td style={{backgroundColor: "lightgreen", textAlign: "center", padding: "10px", border: "1px solid #ccc", borderRadius: "4px"}}>ğŸ’»</td>
    <td style={{textAlign: "center"}}>â†<br />response</td>
    <td style={{backgroundColor: "lightblue", textAlign: "center", padding: "10px", border: "1px solid #ccc", borderRadius: "4px"}}>ğŸŒ</td>
  </tr>
  <tr>
    <td style={{backgroundColor: "lightgreen", textAlign: "center", padding: "10px", border: "1px solid #ccc", borderRadius: "4px"}}>ğŸ’»</td>
    <td style={{textAlign: "center"}}>â†’<br />initialized</td>
    <td style={{backgroundColor: "lightblue", textAlign: "center", padding: "10px", border: "1px solid #ccc", borderRadius: "4px"}}>ğŸŒ</td>
  </tr>
</table>

Le Client confirme la fin de l'initialisation via un message de notification.

### DÃ©couverte

Le Client demande la liste des capacitÃ©s disponibles et le Serveur rÃ©pond avec la liste des outils.

<table style={{width: "100%"}}>
  <tr>
    <td style={{backgroundColor: "lightgreen", textAlign: "center", padding: "10px", border: "1px solid #ccc", borderRadius: "4px"}}>ğŸ’»</td>
    <td style={{textAlign: "center"}}>â†’<br />tools/list</td>
    <td style={{backgroundColor: "lightblue", textAlign: "center", padding: "10px", border: "1px solid #ccc", borderRadius: "4px"}}>ğŸŒ</td>
  </tr>
  <tr>
    <td style={{backgroundColor: "lightgreen", textAlign: "center", padding: "10px", border: "1px solid #ccc", borderRadius: "4px"}}>ğŸ’»</td>
    <td style={{textAlign: "center"}}>â†<br />response</td>
    <td style={{backgroundColor: "lightblue", textAlign: "center", padding: "10px", border: "1px solid #ccc", borderRadius: "4px"}}>ğŸŒ</td>
  </tr>
</table>

Ce processus peut Ãªtre rÃ©pÃ©tÃ© pour chaque outil, ressource ou type de prompt.

### ExÃ©cution

Le Client invoque les capacitÃ©s selon les besoins de l'HÃ´te.

<table style={{width: "100%"}}>
  <tr>
    <td style={{backgroundColor: "lightgreen", textAlign: "center", padding: "10px", border: "1px solid #ccc", borderRadius: "4px"}}>ğŸ’»</td>
    <td style={{textAlign: "center"}}>â†’<br />tools/call</td>
    <td style={{backgroundColor: "lightblue", textAlign: "center", padding: "10px", border: "1px solid #ccc", borderRadius: "4px"}}>ğŸŒ</td>
  </tr>
  <tr>
    <td style={{backgroundColor: "lightgreen", textAlign: "center", padding: "10px", border: "1px solid #ccc", borderRadius: "4px"}}>ğŸ’»</td>
    <td style={{textAlign: "center"}}>â†<br />notification (optional progress)</td>
    <td style={{backgroundColor: "lightblue", textAlign: "center", padding: "10px", border: "1px solid #ccc", borderRadius: "4px"}}>ğŸŒ</td>
  </tr>
  <tr>
    <td style={{backgroundColor: "lightgreen", textAlign: "center", padding: "10px", border: "1px solid #ccc", borderRadius: "4px"}}>ğŸ’»</td>
    <td style={{textAlign: "center"}}>â†<br />response</td>
    <td style={{backgroundColor: "lightblue", textAlign: "center", padding: "10px", border: "1px solid #ccc", borderRadius: "4px"}}>ğŸŒ</td>
  </tr>
</table>

### Terminaison

La connexion est fermÃ©e proprement lorsque plus nÃ©cessaire et le Serveur confirme la demande d'arrÃªt.

<table style={{width: "100%"}}>
  <tr>
    <td style={{backgroundColor: "lightgreen", textAlign: "center", padding: "10px", border: "1px solid #ccc", borderRadius: "4px"}}>ğŸ’»</td>
    <td style={{textAlign: "center"}}>â†’<br />shutdown</td>
    <td style={{backgroundColor: "lightblue", textAlign: "center", padding: "10px", border: "1px solid #ccc", borderRadius: "4px"}}>ğŸŒ</td>
  </tr>
  <tr>
    <td style={{backgroundColor: "lightgreen", textAlign: "center", padding: "10px", border: "1px solid #ccc", borderRadius: "4px"}}>ğŸ’»</td>
    <td style={{textAlign: "center"}}>â†<br />response</td>
    <td style={{backgroundColor: "lightblue", textAlign: "center", padding: "10px", border: "1px solid #ccc", borderRadius: "4px"}}>ğŸŒ</td>
  </tr>
  <tr>
    <td style={{backgroundColor: "lightgreen", textAlign: "center", padding: "10px", border: "1px solid #ccc", borderRadius: "4px"}}>ğŸ’»</td>
    <td style={{textAlign: "center"}}>â†’<br />exit</td>
    <td style={{backgroundColor: "lightblue", textAlign: "center", padding: "10px", border: "1px solid #ccc", borderRadius: "4px"}}>ğŸŒ</td>
  </tr>
</table>

Le Client envoie le message de sortie final pour terminer la connexion.

## Ã‰volution du protocole

Le protocole MCP est conÃ§u pour Ãªtre extensible et adaptable. La phase d'initialisation inclut la nÃ©gociation de version, permettant la rÃ©trocompatibilitÃ© au fil de l'Ã©volution du protocole. De plus, la dÃ©couverte des capacitÃ©s permet aux Clients de s'adapter aux fonctionnalitÃ©s spÃ©cifiques de chaque Serveur, permettant de mÃ©langer des Serveurs basiques et avancÃ©s dans le mÃªme Ã©cosystÃ¨me.
